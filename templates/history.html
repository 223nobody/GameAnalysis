<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PUBG预测历史记录</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      .history-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .history-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .history-header h1 {
        color: #fff;
        font-size: 32px;
        margin-bottom: 10px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .stat-card h3 {
        color: #4ecdc4;
        margin: 0 0 10px 0;
        font-size: 14px;
        text-transform: uppercase;
      }

      .stat-card .value {
        color: #fff;
        font-size: 24px;
        font-weight: bold;
      }

      .history-table {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 20px;
      }

      .table-header {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        display: grid;
        grid-template-columns: 40px 80px 80px 80px 80px 100px 100px 80px 100px 80px 80px 100px 80px;
        gap: 10px;
        font-weight: bold;
        color: #4ecdc4;
        font-size: 12px;
      }

      .table-row {
        padding: 12px 15px;
        display: grid;
        grid-template-columns: 40px 80px 80px 80px 80px 100px 100px 80px 100px 80px 80px 100px 80px;
        gap: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: #e0e0e0;
        font-size: 12px;
        align-items: center;
      }

      .table-row:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .confidence-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
      }

      .confidence-high {
        background: linear-gradient(45deg, #4ecdc4, #44a08d);
        color: #fff;
      }

      .confidence-medium {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: #fff;
      }

      .confidence-low {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: #fff;
      }

      .result-percentage {
        font-weight: bold;
        color: #4ecdc4;
      }

      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .pagination button {
        padding: 8px 16px;
        background: linear-gradient(45deg, #4ecdc4, #44a08d);
        border: none;
        border-radius: 8px;
        color: #fff;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        min-width: 80px;
      }

      .pagination button:hover:not(:disabled) {
        background: linear-gradient(45deg, #44a08d, #4ecdc4);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
      }

      .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        background: rgba(255, 255, 255, 0.1);
      }

      .page-size-selector {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #ccc;
        font-size: 14px;
      }

      .page-size-selector select {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: #fff;
        padding: 6px 10px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .page-size-selector select:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: #4ecdc4;
      }

      .page-size-selector select:focus {
        outline: none;
        border-color: #4ecdc4;
        box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
      }

      .page-info {
        color: #ccc;
        font-size: 14px;
        text-align: center;
        min-width: 200px;
      }

      .page-navigation {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .loading {
        text-align: center;
        color: #ccc;
        padding: 40px;
      }

      /* 导航栏样式已在外部CSS中统一定义 */

      /* 删除按钮样式 */
      .delete-btn {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        border: none;
        border-radius: 6px;
        color: white;
        padding: 4px 8px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .delete-btn:hover {
        background: linear-gradient(45deg, #ee5a24, #ff6b6b);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
      }

      .delete-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* 复选框样式 */
      .record-checkbox {
        width: 16px;
        height: 16px;
        accent-color: #4ecdc4;
      }

      /* 批量操作栏 */
      .bulk-actions {
        display: none;
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        align-items: center;
        gap: 15px;
      }

      .bulk-actions.show {
        display: flex;
      }

      .bulk-delete-btn {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        border: none;
        border-radius: 8px;
        color: white;
        padding: 8px 16px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .bulk-delete-btn:hover {
        background: linear-gradient(45deg, #ee5a24, #ff6b6b);
        transform: translateY(-1px);
      }

      .select-all-checkbox {
        width: 18px;
        height: 18px;
        accent-color: #4ecdc4;
      }

      /* 消息提示样式 */
      .message {
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-weight: 500;
        display: none;
      }

      .message.success {
        background: rgba(76, 175, 80, 0.2);
        border: 1px solid rgba(76, 175, 80, 0.4);
        color: #4caf50;
      }

      .message.error {
        background: rgba(244, 67, 54, 0.2);
        border: 1px solid rgba(244, 67, 54, 0.4);
        color: #f44336;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="history-container">
        <div class="nav">
          <a href="/">首页</a>
          <a href="/predict">预测器</a>
          <a href="/history" class="active">历史记录</a>
        </div>

        <div class="history-header">
          <h1>📊 PUBG预测历史记录</h1>
          <p style="color: #ccc">查看您的预测历史和统计信息</p>
        </div>

        <!-- 消息提示 -->
        <div id="messageContainer">
          <div id="successMessage" class="message success"></div>
          <div id="errorMessage" class="message error"></div>
        </div>

        <!-- 统计信息 -->
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <h3>总预测次数</h3>
            <div class="value" id="totalPredictions">-</div>
          </div>
          <div class="stat-card">
            <h3>平均胜率</h3>
            <div class="value" id="avgWinRate">-</div>
          </div>
          <div class="stat-card">
            <h3>最高胜率</h3>
            <div class="value" id="maxWinRate">-</div>
          </div>
          <div class="stat-card">
            <h3>高置信度</h3>
            <div class="value" id="highConfidence">-</div>
          </div>
        </div>

        <!-- 批量操作栏 -->
        <div class="bulk-actions" id="bulkActions">
          <input
            type="checkbox"
            class="select-all-checkbox"
            id="selectAll"
            onchange="toggleSelectAll()"
          />
          <label for="selectAll" style="color: #ccc">全选</label>
          <span id="selectedCount" style="color: #ccc">已选择 0 条记录</span>
          <button class="bulk-delete-btn" onclick="bulkDeleteRecords()">
            🗑️ 批量删除
          </button>
        </div>

        <!-- 历史记录表格 -->
        <div class="history-table">
          <div class="table-header">
            <div>选择</div>
            <div>人数</div>
            <div>队伍</div>
            <div>击杀</div>
            <div>击倒</div>
            <div>伤害</div>
            <div>生存时间</div>
            <div>助攻</div>
            <div>步行距离</div>
            <div>载具距离</div>
            <div>胜率</div>
            <div>置信度</div>
          </div>
          <div id="historyTableBody">
            <div class="loading">正在加载历史记录...</div>
          </div>
        </div>

        <!-- 分页控件 -->
        <div class="pagination" id="pagination">
          <!-- 每页记录数选择 -->
          <div class="page-size-selector">
            <label for="pageSizeSelect">每页显示:</label>
            <select id="pageSizeSelect" onchange="changePageSize()">
              <option value="10" selected>10条</option>
              <option value="20">20条</option>
              <option value="30">30条</option>
            </select>
          </div>

          <!-- 分页导航 -->
          <div class="page-navigation">
            <button id="firstBtn" onclick="goToFirstPage()" title="首页">
              ⏮️ 首页
            </button>
            <button
              id="prevBtn"
              onclick="loadPage(currentPage - 1)"
              title="上一页"
            >
              ⬅️ 上一页
            </button>

            <div class="page-info">
              <span id="pageInfo">-</span>
            </div>

            <button
              id="nextBtn"
              onclick="loadPage(currentPage + 1)"
              title="下一页"
            >
              下一页 ➡️
            </button>
            <button id="lastBtn" onclick="goToLastPage()" title="末页">
              末页 ⏭️
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentPage = 0;
      let pageSize = 10;
      let totalPages = 0;
      let totalItems = 0;

      // 页面加载时获取数据
      $(document).ready(function () {
        loadStatistics();
        loadPage(0);
      });

      // 加载统计信息
      function loadStatistics() {
        $.get("/api/history/stats")
          .done(function (data) {
            $("#totalPredictions").text(data.total_predictions);
            $("#avgWinRate").text(data.avg_win_rate + "%");
            $("#maxWinRate").text(data.max_win_rate + "%");
            $("#highConfidence").text(data.confidence_distribution.high);
          })
          .fail(function () {
            console.error("加载统计信息失败");
          });
      }

      // 加载指定页面的历史记录
      function loadPage(page) {
        // 边界检查
        if (page < 0 || (totalPages > 0 && page >= totalPages)) {
          return;
        }

        currentPage = page;

        $("#historyTableBody").html('<div class="loading">正在加载...</div>');

        // 使用新的分页API
        $.get(`/api/history?page=${page + 1}&per_page=${pageSize}`)
          .done(function (data) {
            if (data.pagination) {
              displayHistory(data.history);
              updatePaginationNew(data.pagination);
            } else {
              // 向后兼容旧API
              displayHistory(data.history);
              updatePagination(data);
            }
          })
          .fail(function (xhr) {
            const errorMsg = xhr.responseJSON
              ? xhr.responseJSON.error
              : "加载失败";
            $("#historyTableBody").html(
              `<div class="loading" style="color: #ff6b6b;">${errorMsg}</div>`
            );
          });
      }

      // 显示历史记录
      function displayHistory(history) {
        const tbody = $("#historyTableBody");
        tbody.empty();

        if (history.length === 0) {
          tbody.html('<div class="loading">暂无历史记录</div>');
          return;
        }

        history.forEach(function (record) {
          const row = $(`
                    <div class="table-row" data-record-id="${record.id}">
                        <div><input type="checkbox" class="record-checkbox" value="${record.id}" onchange="updateSelectedCount()"></div>
                        <div>${record.sumpeople}</div>
                        <div>${record.teamsize}</div>
                        <div>${record.sumkill}</div>
                        <div>${record.sumfall}</div>
                        <div>${record.damage}</div>
                        <div>${record.survival_time}s</div>
                        <div>${record.assist}</div>
                        <div>${record.sumdist_walk}m</div>
                        <div>${record.sumdist_ride}m</div>
                        <div class="result-percentage">${record.result}%</div>
                        <div><span class="confidence-badge confidence-${record.confidence}">${record.confidence}</span></div>
                    </div>
                `);
          tbody.append(row);
        });

        updateSelectedCount();
      }

      // 更新分页信息
      function updatePagination(data) {
        const totalPages = Math.ceil(data.total_count / pageSize);
        $("#pageInfo").text(
          `第 ${currentPage + 1} 页，共 ${totalPages} 页 (${
            data.total_count
          } 条记录)`
        );

        $("#prevBtn").prop("disabled", currentPage === 0);
        $("#nextBtn").prop("disabled", !data.has_more);
      }

      // 新的分页信息更新函数
      function updatePaginationNew(pagination) {
        // 更新全局变量
        totalPages = pagination.total_pages;
        totalItems = pagination.total_items;
        currentPage = pagination.current_page - 1; // API返回1-based，前端使用0-based

        // 更新页面信息显示
        $("#pageInfo").text(
          `第 ${pagination.current_page} 页，共 ${pagination.total_pages} 页 (共 ${pagination.total_items} 条记录)`
        );

        // 更新按钮状态
        $("#firstBtn").prop("disabled", !pagination.has_prev);
        $("#prevBtn").prop("disabled", !pagination.has_prev);
        $("#nextBtn").prop("disabled", !pagination.has_next);
        $("#lastBtn").prop("disabled", !pagination.has_next);

        // 更新每页记录数选择器
        $("#pageSizeSelect").val(pageSize);
      }

      // 跳转到首页
      function goToFirstPage() {
        if (currentPage > 0) {
          loadPage(0);
        }
      }

      // 跳转到末页
      function goToLastPage() {
        if (totalPages > 0 && currentPage < totalPages - 1) {
          loadPage(totalPages - 1);
        }
      }

      // 改变每页记录数
      function changePageSize() {
        const newPageSize = parseInt($("#pageSizeSelect").val());
        if (newPageSize !== pageSize) {
          pageSize = newPageSize;
          currentPage = 0; // 重置到第一页
          loadPage(0);
        }
      }

      // 删除单条记录
      function deleteRecord(recordId) {
        if (!confirm("确定要删除这条预测记录吗？")) {
          return;
        }

        const deleteBtn = $(
          `.table-row[data-record-id="${recordId}"] .delete-btn`
        );
        deleteBtn.prop("disabled", true).text("删除中...");

        $.ajax({
          url: `/api/history/${recordId}`,
          method: "DELETE",
          success: function (response) {
            showMessage("记录删除成功", "success");
            $(`.table-row[data-record-id="${recordId}"]`).fadeOut(
              300,
              function () {
                $(this).remove();
                updateSelectedCount();

                // 检查当前页是否还有记录，如果没有则跳转到上一页
                const remainingRows = $(".table-row[data-record-id]").length;
                if (remainingRows === 0 && currentPage > 0) {
                  loadPage(currentPage - 1);
                } else if (remainingRows === 0 && currentPage === 0) {
                  // 如果是第一页且没有记录了，重新加载统计信息
                  loadStatistics();
                  $("#historyTableBody").html(
                    '<div class="loading">暂无历史记录</div>'
                  );
                  updatePaginationNew({
                    current_page: 1,
                    total_pages: 1,
                    total_items: 0,
                    has_prev: false,
                    has_next: false,
                  });
                }
              }
            );
          },
          error: function (xhr) {
            const errorMsg = xhr.responseJSON
              ? xhr.responseJSON.error
              : "删除失败";
            showMessage(errorMsg, "error");
            deleteBtn.prop("disabled", false).text("🗑️");
          },
        });
      }

      // 更新选中计数
      function updateSelectedCount() {
        const selectedCount = $(".record-checkbox:checked").length;
        const totalCount = $(".record-checkbox").length;

        $("#selectedCount").text(`已选择 ${selectedCount} 条记录`);

        if (selectedCount > 0) {
          $("#bulkActions").addClass("show");
        } else {
          $("#bulkActions").removeClass("show");
        }

        // 更新全选复选框状态
        const selectAllCheckbox = $("#selectAll");
        if (selectedCount === 0) {
          selectAllCheckbox.prop("indeterminate", false).prop("checked", false);
        } else if (selectedCount === totalCount) {
          selectAllCheckbox.prop("indeterminate", false).prop("checked", true);
        } else {
          selectAllCheckbox.prop("indeterminate", true);
        }
      }

      // 全选/取消全选
      function toggleSelectAll() {
        const selectAll = $("#selectAll").prop("checked");
        $(".record-checkbox").prop("checked", selectAll);
        updateSelectedCount();
      }

      // 批量删除记录
      function bulkDeleteRecords() {
        const selectedIds = $(".record-checkbox:checked")
          .map(function () {
            return $(this).val();
          })
          .get();

        if (selectedIds.length === 0) {
          showMessage("请先选择要删除的记录", "error");
          return;
        }

        if (
          !confirm(
            `确定要删除选中的 ${selectedIds.length} 条记录吗？此操作不可撤销。`
          )
        ) {
          return;
        }

        const bulkDeleteBtn = $(".bulk-delete-btn");
        bulkDeleteBtn.prop("disabled", true).text("删除中...");

        let deletedCount = 0;
        let errorCount = 0;

        selectedIds.forEach(function (recordId) {
          $.ajax({
            url: `/api/history/${recordId}`,
            method: "DELETE",
            success: function () {
              deletedCount++;
              $(`.table-row[data-record-id="${recordId}"]`).fadeOut(
                300,
                function () {
                  $(this).remove();
                  if (deletedCount + errorCount === selectedIds.length) {
                    finishBulkDelete(deletedCount, errorCount, bulkDeleteBtn);
                  }
                }
              );
            },
            error: function () {
              errorCount++;
              if (deletedCount + errorCount === selectedIds.length) {
                finishBulkDelete(deletedCount, errorCount, bulkDeleteBtn);
              }
            },
          });
        });
      }

      // 完成批量删除
      function finishBulkDelete(deletedCount, errorCount, bulkDeleteBtn) {
        bulkDeleteBtn.prop("disabled", false).text("🗑️ 批量删除");

        if (errorCount === 0) {
          showMessage(`成功删除 ${deletedCount} 条记录`, "success");
        } else {
          showMessage(
            `删除完成：成功 ${deletedCount} 条，失败 ${errorCount} 条`,
            "error"
          );
        }

        updateSelectedCount();

        // 检查当前页是否还有记录，如果没有则重新加载当前页或上一页
        const remainingRows = $(".table-row[data-record-id]").length;
        if (remainingRows === 0) {
          if (currentPage > 0) {
            loadPage(currentPage - 1);
          } else {
            // 重新加载第一页和统计信息
            loadStatistics();
            loadPage(0);
          }
        }
      }

      // 显示消息
      function showMessage(message, type) {
        const messageElement =
          type === "success" ? $("#successMessage") : $("#errorMessage");
        messageElement.text(message).show();

        setTimeout(function () {
          messageElement.fadeOut();
        }, 3000);
      }
    </script>
  </body>
</html>
