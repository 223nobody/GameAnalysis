<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PUBGé¢„æµ‹å†å²è®°å½•</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      .history-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .history-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .history-header h1 {
        color: #fff;
        font-size: 32px;
        margin-bottom: 10px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .stat-card h3 {
        color: #4ecdc4;
        margin: 0 0 10px 0;
        font-size: 14px;
        text-transform: uppercase;
      }

      .stat-card .value {
        color: #fff;
        font-size: 24px;
        font-weight: bold;
      }

      .history-table {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 20px;
      }

      .table-header {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        display: grid;
        grid-template-columns: 40px 80px 80px 80px 80px 100px 100px 80px 100px 80px 80px 100px 80px;
        gap: 10px;
        font-weight: bold;
        color: #4ecdc4;
        font-size: 12px;
      }

      .table-row {
        padding: 12px 15px;
        display: grid;
        grid-template-columns: 40px 80px 80px 80px 80px 100px 100px 80px 100px 80px 80px 100px 80px;
        gap: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: #e0e0e0;
        font-size: 12px;
        align-items: center;
      }

      .table-row:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .confidence-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
      }

      .confidence-high {
        background: linear-gradient(45deg, #4ecdc4, #44a08d);
        color: #fff;
      }

      .confidence-medium {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: #fff;
      }

      .confidence-low {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: #fff;
      }

      .result-percentage {
        font-weight: bold;
        color: #4ecdc4;
      }

      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .pagination button {
        padding: 8px 16px;
        background: linear-gradient(45deg, #4ecdc4, #44a08d);
        border: none;
        border-radius: 8px;
        color: #fff;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        min-width: 80px;
      }

      .pagination button:hover:not(:disabled) {
        background: linear-gradient(45deg, #44a08d, #4ecdc4);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
      }

      .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        background: rgba(255, 255, 255, 0.1);
      }

      .page-size-selector {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #ccc;
        font-size: 14px;
      }

      .page-size-selector select {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: #fff;
        padding: 6px 10px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .page-size-selector select:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: #4ecdc4;
      }

      .page-size-selector select:focus {
        outline: none;
        border-color: #4ecdc4;
        box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
      }

      .page-info {
        color: #ccc;
        font-size: 14px;
        text-align: center;
        min-width: 200px;
      }

      .page-navigation {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .loading {
        text-align: center;
        color: #ccc;
        padding: 40px;
      }

      /* å¯¼èˆªæ æ ·å¼å·²åœ¨å¤–éƒ¨CSSä¸­ç»Ÿä¸€å®šä¹‰ */

      /* åˆ é™¤æŒ‰é’®æ ·å¼ */
      .delete-btn {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        border: none;
        border-radius: 6px;
        color: white;
        padding: 4px 8px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .delete-btn:hover {
        background: linear-gradient(45deg, #ee5a24, #ff6b6b);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
      }

      .delete-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* å¤é€‰æ¡†æ ·å¼ */
      .record-checkbox {
        width: 16px;
        height: 16px;
        accent-color: #4ecdc4;
      }

      /* æ‰¹é‡æ“ä½œæ  */
      .bulk-actions {
        display: none;
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        align-items: center;
        gap: 15px;
      }

      .bulk-actions.show {
        display: flex;
      }

      .bulk-delete-btn {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        border: none;
        border-radius: 8px;
        color: white;
        padding: 8px 16px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .bulk-delete-btn:hover {
        background: linear-gradient(45deg, #ee5a24, #ff6b6b);
        transform: translateY(-1px);
      }

      .select-all-checkbox {
        width: 18px;
        height: 18px;
        accent-color: #4ecdc4;
      }

      /* æ¶ˆæ¯æç¤ºæ ·å¼ */
      .message {
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-weight: 500;
        display: none;
      }

      .message.success {
        background: rgba(76, 175, 80, 0.2);
        border: 1px solid rgba(76, 175, 80, 0.4);
        color: #4caf50;
      }

      .message.error {
        background: rgba(244, 67, 54, 0.2);
        border: 1px solid rgba(244, 67, 54, 0.4);
        color: #f44336;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="history-container">
        <div class="nav">
          <a href="/">é¦–é¡µ</a>
          <a href="/predict">é¢„æµ‹å™¨</a>
          <a href="/history" class="active">å†å²è®°å½•</a>
        </div>

        <div class="history-header">
          <h1>ğŸ“Š PUBGé¢„æµ‹å†å²è®°å½•</h1>
          <p style="color: #ccc">æŸ¥çœ‹æ‚¨çš„é¢„æµ‹å†å²å’Œç»Ÿè®¡ä¿¡æ¯</p>
        </div>

        <!-- æ¶ˆæ¯æç¤º -->
        <div id="messageContainer">
          <div id="successMessage" class="message success"></div>
          <div id="errorMessage" class="message error"></div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <h3>æ€»é¢„æµ‹æ¬¡æ•°</h3>
            <div class="value" id="totalPredictions">-</div>
          </div>
          <div class="stat-card">
            <h3>å¹³å‡èƒœç‡</h3>
            <div class="value" id="avgWinRate">-</div>
          </div>
          <div class="stat-card">
            <h3>æœ€é«˜èƒœç‡</h3>
            <div class="value" id="maxWinRate">-</div>
          </div>
          <div class="stat-card">
            <h3>é«˜ç½®ä¿¡åº¦</h3>
            <div class="value" id="highConfidence">-</div>
          </div>
        </div>

        <!-- æ‰¹é‡æ“ä½œæ  -->
        <div class="bulk-actions" id="bulkActions">
          <input
            type="checkbox"
            class="select-all-checkbox"
            id="selectAll"
            onchange="toggleSelectAll()"
          />
          <label for="selectAll" style="color: #ccc">å…¨é€‰</label>
          <span id="selectedCount" style="color: #ccc">å·²é€‰æ‹© 0 æ¡è®°å½•</span>
          <button class="bulk-delete-btn" onclick="bulkDeleteRecords()">
            ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤
          </button>
        </div>

        <!-- å†å²è®°å½•è¡¨æ ¼ -->
        <div class="history-table">
          <div class="table-header">
            <div>é€‰æ‹©</div>
            <div>äººæ•°</div>
            <div>é˜Ÿä¼</div>
            <div>å‡»æ€</div>
            <div>å‡»å€’</div>
            <div>ä¼¤å®³</div>
            <div>ç”Ÿå­˜æ—¶é—´</div>
            <div>åŠ©æ”»</div>
            <div>æ­¥è¡Œè·ç¦»</div>
            <div>è½½å…·è·ç¦»</div>
            <div>èƒœç‡</div>
            <div>ç½®ä¿¡åº¦</div>
          </div>
          <div id="historyTableBody">
            <div class="loading">æ­£åœ¨åŠ è½½å†å²è®°å½•...</div>
          </div>
        </div>

        <!-- åˆ†é¡µæ§ä»¶ -->
        <div class="pagination" id="pagination">
          <!-- æ¯é¡µè®°å½•æ•°é€‰æ‹© -->
          <div class="page-size-selector">
            <label for="pageSizeSelect">æ¯é¡µæ˜¾ç¤º:</label>
            <select id="pageSizeSelect" onchange="changePageSize()">
              <option value="10" selected>10æ¡</option>
              <option value="20">20æ¡</option>
              <option value="30">30æ¡</option>
            </select>
          </div>

          <!-- åˆ†é¡µå¯¼èˆª -->
          <div class="page-navigation">
            <button id="firstBtn" onclick="goToFirstPage()" title="é¦–é¡µ">
              â®ï¸ é¦–é¡µ
            </button>
            <button
              id="prevBtn"
              onclick="loadPage(currentPage - 1)"
              title="ä¸Šä¸€é¡µ"
            >
              â¬…ï¸ ä¸Šä¸€é¡µ
            </button>

            <div class="page-info">
              <span id="pageInfo">-</span>
            </div>

            <button
              id="nextBtn"
              onclick="loadPage(currentPage + 1)"
              title="ä¸‹ä¸€é¡µ"
            >
              ä¸‹ä¸€é¡µ â¡ï¸
            </button>
            <button id="lastBtn" onclick="goToLastPage()" title="æœ«é¡µ">
              æœ«é¡µ â­ï¸
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentPage = 0;
      let pageSize = 10;
      let totalPages = 0;
      let totalItems = 0;

      // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
      $(document).ready(function () {
        loadStatistics();
        loadPage(0);
      });

      // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
      function loadStatistics() {
        $.get("/api/history/stats")
          .done(function (data) {
            $("#totalPredictions").text(data.total_predictions);
            $("#avgWinRate").text(data.avg_win_rate + "%");
            $("#maxWinRate").text(data.max_win_rate + "%");
            $("#highConfidence").text(data.confidence_distribution.high);
          })
          .fail(function () {
            console.error("åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥");
          });
      }

      // åŠ è½½æŒ‡å®šé¡µé¢çš„å†å²è®°å½•
      function loadPage(page) {
        // è¾¹ç•Œæ£€æŸ¥
        if (page < 0 || (totalPages > 0 && page >= totalPages)) {
          return;
        }

        currentPage = page;

        $("#historyTableBody").html('<div class="loading">æ­£åœ¨åŠ è½½...</div>');

        // ä½¿ç”¨æ–°çš„åˆ†é¡µAPI
        $.get(`/api/history?page=${page + 1}&per_page=${pageSize}`)
          .done(function (data) {
            if (data.pagination) {
              displayHistory(data.history);
              updatePaginationNew(data.pagination);
            } else {
              // å‘åå…¼å®¹æ—§API
              displayHistory(data.history);
              updatePagination(data);
            }
          })
          .fail(function (xhr) {
            const errorMsg = xhr.responseJSON
              ? xhr.responseJSON.error
              : "åŠ è½½å¤±è´¥";
            $("#historyTableBody").html(
              `<div class="loading" style="color: #ff6b6b;">${errorMsg}</div>`
            );
          });
      }

      // æ˜¾ç¤ºå†å²è®°å½•
      function displayHistory(history) {
        const tbody = $("#historyTableBody");
        tbody.empty();

        if (history.length === 0) {
          tbody.html('<div class="loading">æš‚æ— å†å²è®°å½•</div>');
          return;
        }

        history.forEach(function (record) {
          const row = $(`
                    <div class="table-row" data-record-id="${record.id}">
                        <div><input type="checkbox" class="record-checkbox" value="${record.id}" onchange="updateSelectedCount()"></div>
                        <div>${record.sumpeople}</div>
                        <div>${record.teamsize}</div>
                        <div>${record.sumkill}</div>
                        <div>${record.sumfall}</div>
                        <div>${record.damage}</div>
                        <div>${record.survival_time}s</div>
                        <div>${record.assist}</div>
                        <div>${record.sumdist_walk}m</div>
                        <div>${record.sumdist_ride}m</div>
                        <div class="result-percentage">${record.result}%</div>
                        <div><span class="confidence-badge confidence-${record.confidence}">${record.confidence}</span></div>
                    </div>
                `);
          tbody.append(row);
        });

        updateSelectedCount();
      }

      // æ›´æ–°åˆ†é¡µä¿¡æ¯
      function updatePagination(data) {
        const totalPages = Math.ceil(data.total_count / pageSize);
        $("#pageInfo").text(
          `ç¬¬ ${currentPage + 1} é¡µï¼Œå…± ${totalPages} é¡µ (${
            data.total_count
          } æ¡è®°å½•)`
        );

        $("#prevBtn").prop("disabled", currentPage === 0);
        $("#nextBtn").prop("disabled", !data.has_more);
      }

      // æ–°çš„åˆ†é¡µä¿¡æ¯æ›´æ–°å‡½æ•°
      function updatePaginationNew(pagination) {
        // æ›´æ–°å…¨å±€å˜é‡
        totalPages = pagination.total_pages;
        totalItems = pagination.total_items;
        currentPage = pagination.current_page - 1; // APIè¿”å›1-basedï¼Œå‰ç«¯ä½¿ç”¨0-based

        // æ›´æ–°é¡µé¢ä¿¡æ¯æ˜¾ç¤º
        $("#pageInfo").text(
          `ç¬¬ ${pagination.current_page} é¡µï¼Œå…± ${pagination.total_pages} é¡µ (å…± ${pagination.total_items} æ¡è®°å½•)`
        );

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        $("#firstBtn").prop("disabled", !pagination.has_prev);
        $("#prevBtn").prop("disabled", !pagination.has_prev);
        $("#nextBtn").prop("disabled", !pagination.has_next);
        $("#lastBtn").prop("disabled", !pagination.has_next);

        // æ›´æ–°æ¯é¡µè®°å½•æ•°é€‰æ‹©å™¨
        $("#pageSizeSelect").val(pageSize);
      }

      // è·³è½¬åˆ°é¦–é¡µ
      function goToFirstPage() {
        if (currentPage > 0) {
          loadPage(0);
        }
      }

      // è·³è½¬åˆ°æœ«é¡µ
      function goToLastPage() {
        if (totalPages > 0 && currentPage < totalPages - 1) {
          loadPage(totalPages - 1);
        }
      }

      // æ”¹å˜æ¯é¡µè®°å½•æ•°
      function changePageSize() {
        const newPageSize = parseInt($("#pageSizeSelect").val());
        if (newPageSize !== pageSize) {
          pageSize = newPageSize;
          currentPage = 0; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
          loadPage(0);
        }
      }

      // åˆ é™¤å•æ¡è®°å½•
      function deleteRecord(recordId) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡é¢„æµ‹è®°å½•å—ï¼Ÿ")) {
          return;
        }

        const deleteBtn = $(
          `.table-row[data-record-id="${recordId}"] .delete-btn`
        );
        deleteBtn.prop("disabled", true).text("åˆ é™¤ä¸­...");

        $.ajax({
          url: `/api/history/${recordId}`,
          method: "DELETE",
          success: function (response) {
            showMessage("è®°å½•åˆ é™¤æˆåŠŸ", "success");
            $(`.table-row[data-record-id="${recordId}"]`).fadeOut(
              300,
              function () {
                $(this).remove();
                updateSelectedCount();

                // æ£€æŸ¥å½“å‰é¡µæ˜¯å¦è¿˜æœ‰è®°å½•ï¼Œå¦‚æœæ²¡æœ‰åˆ™è·³è½¬åˆ°ä¸Šä¸€é¡µ
                const remainingRows = $(".table-row[data-record-id]").length;
                if (remainingRows === 0 && currentPage > 0) {
                  loadPage(currentPage - 1);
                } else if (remainingRows === 0 && currentPage === 0) {
                  // å¦‚æœæ˜¯ç¬¬ä¸€é¡µä¸”æ²¡æœ‰è®°å½•äº†ï¼Œé‡æ–°åŠ è½½ç»Ÿè®¡ä¿¡æ¯
                  loadStatistics();
                  $("#historyTableBody").html(
                    '<div class="loading">æš‚æ— å†å²è®°å½•</div>'
                  );
                  updatePaginationNew({
                    current_page: 1,
                    total_pages: 1,
                    total_items: 0,
                    has_prev: false,
                    has_next: false,
                  });
                }
              }
            );
          },
          error: function (xhr) {
            const errorMsg = xhr.responseJSON
              ? xhr.responseJSON.error
              : "åˆ é™¤å¤±è´¥";
            showMessage(errorMsg, "error");
            deleteBtn.prop("disabled", false).text("ğŸ—‘ï¸");
          },
        });
      }

      // æ›´æ–°é€‰ä¸­è®¡æ•°
      function updateSelectedCount() {
        const selectedCount = $(".record-checkbox:checked").length;
        const totalCount = $(".record-checkbox").length;

        $("#selectedCount").text(`å·²é€‰æ‹© ${selectedCount} æ¡è®°å½•`);

        if (selectedCount > 0) {
          $("#bulkActions").addClass("show");
        } else {
          $("#bulkActions").removeClass("show");
        }

        // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
        const selectAllCheckbox = $("#selectAll");
        if (selectedCount === 0) {
          selectAllCheckbox.prop("indeterminate", false).prop("checked", false);
        } else if (selectedCount === totalCount) {
          selectAllCheckbox.prop("indeterminate", false).prop("checked", true);
        } else {
          selectAllCheckbox.prop("indeterminate", true);
        }
      }

      // å…¨é€‰/å–æ¶ˆå…¨é€‰
      function toggleSelectAll() {
        const selectAll = $("#selectAll").prop("checked");
        $(".record-checkbox").prop("checked", selectAll);
        updateSelectedCount();
      }

      // æ‰¹é‡åˆ é™¤è®°å½•
      function bulkDeleteRecords() {
        const selectedIds = $(".record-checkbox:checked")
          .map(function () {
            return $(this).val();
          })
          .get();

        if (selectedIds.length === 0) {
          showMessage("è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•", "error");
          return;
        }

        if (
          !confirm(
            `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedIds.length} æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`
          )
        ) {
          return;
        }

        const bulkDeleteBtn = $(".bulk-delete-btn");
        bulkDeleteBtn.prop("disabled", true).text("åˆ é™¤ä¸­...");

        let deletedCount = 0;
        let errorCount = 0;

        selectedIds.forEach(function (recordId) {
          $.ajax({
            url: `/api/history/${recordId}`,
            method: "DELETE",
            success: function () {
              deletedCount++;
              $(`.table-row[data-record-id="${recordId}"]`).fadeOut(
                300,
                function () {
                  $(this).remove();
                  if (deletedCount + errorCount === selectedIds.length) {
                    finishBulkDelete(deletedCount, errorCount, bulkDeleteBtn);
                  }
                }
              );
            },
            error: function () {
              errorCount++;
              if (deletedCount + errorCount === selectedIds.length) {
                finishBulkDelete(deletedCount, errorCount, bulkDeleteBtn);
              }
            },
          });
        });
      }

      // å®Œæˆæ‰¹é‡åˆ é™¤
      function finishBulkDelete(deletedCount, errorCount, bulkDeleteBtn) {
        bulkDeleteBtn.prop("disabled", false).text("ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤");

        if (errorCount === 0) {
          showMessage(`æˆåŠŸåˆ é™¤ ${deletedCount} æ¡è®°å½•`, "success");
        } else {
          showMessage(
            `åˆ é™¤å®Œæˆï¼šæˆåŠŸ ${deletedCount} æ¡ï¼Œå¤±è´¥ ${errorCount} æ¡`,
            "error"
          );
        }

        updateSelectedCount();

        // æ£€æŸ¥å½“å‰é¡µæ˜¯å¦è¿˜æœ‰è®°å½•ï¼Œå¦‚æœæ²¡æœ‰åˆ™é‡æ–°åŠ è½½å½“å‰é¡µæˆ–ä¸Šä¸€é¡µ
        const remainingRows = $(".table-row[data-record-id]").length;
        if (remainingRows === 0) {
          if (currentPage > 0) {
            loadPage(currentPage - 1);
          } else {
            // é‡æ–°åŠ è½½ç¬¬ä¸€é¡µå’Œç»Ÿè®¡ä¿¡æ¯
            loadStatistics();
            loadPage(0);
          }
        }
      }

      // æ˜¾ç¤ºæ¶ˆæ¯
      function showMessage(message, type) {
        const messageElement =
          type === "success" ? $("#successMessage") : $("#errorMessage");
        messageElement.text(message).show();

        setTimeout(function () {
          messageElement.fadeOut();
        }, 3000);
      }
    </script>
  </body>
</html>
